(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[125],{30426:(e,t,a)=>{"use strict";a.d(t,{default:()=>I});var n=a(95155),s=a(12115),i=a(50276),l=a(3998),r=a(86948),o=a(33406),c=a(65229),d=a(64269);function u(e){let{...t}=e;return(0,n.jsx)(o.bL,{"data-slot":"dialog",...t})}function m(e){let{...t}=e;return(0,n.jsx)(o.ZL,{"data-slot":"dialog-portal",...t})}function h(e){let{className:t,...a}=e;return(0,n.jsx)(o.hJ,{"data-slot":"dialog-overlay",className:(0,d.cn)("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",t),...a})}function g(e){let{className:t,children:a,...s}=e;return(0,n.jsxs)(m,{"data-slot":"dialog-portal",children:[(0,n.jsx)(h,{}),(0,n.jsxs)(o.UC,{"data-slot":"dialog-content",className:(0,d.cn)("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",t),...s,children:[a,(0,n.jsxs)(o.bm,{className:"ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[(0,n.jsx)(c.A,{}),(0,n.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})}function p(e){let{className:t,...a}=e;return(0,n.jsx)("div",{"data-slot":"dialog-header",className:(0,d.cn)("flex flex-col gap-2 text-center sm:text-left",t),...a})}function f(e){let{className:t,...a}=e;return(0,n.jsx)("div",{"data-slot":"dialog-footer",className:(0,d.cn)("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",t),...a})}function b(e){let{className:t,...a}=e;return(0,n.jsx)(o.hE,{"data-slot":"dialog-title",className:(0,d.cn)("text-lg leading-none font-semibold",t),...a})}var x=a(65142),v=a(76444),w=a(32467);let y=(0,a(83101).F)("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function j(e){let{className:t,variant:a,asChild:s=!1,...i}=e,l=s?w.DX:"span";return(0,n.jsx)(l,{"data-slot":"badge",className:(0,d.cn)(y({variant:a}),t),...i})}var N=a(26983),k=a(33946),S=a(67952),M=a(75924);function _(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate(),s=new Date(t,10,5),i=new Date(t+1,0,7);return 11===a||12===a||1===a&&n<=7?{start:new Date(t,10,5),end:new Date(t+ +(1!==a),0,7)}:{start:s,end:i}}let P=["2025-10-31","2025-11-04"];function D(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,{start:a,end:n}=_(t);if(e>=a&&e<=n)return!0;let s=C(e);return P.includes(s)}function C(e){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(n)}let B=[{label:"1:00 PM - 1:30 PM",start:"13:00",end:"13:30"},{label:"1:30 PM - 2:00 PM",start:"13:30",end:"14:00"},{label:"2:00 PM - 2:30 PM",start:"14:00",end:"14:30"},{label:"2:30 PM - 3:00 PM",start:"14:30",end:"15:00"}],E=[{label:"8:00 PM - 8:30 PM",start:"20:00",end:"20:30"},{label:"8:30 PM - 9:00 PM",start:"20:30",end:"21:00"},{label:"9:00 PM - 9:30 PM",start:"21:00",end:"21:30"},{label:"9:30 PM - 10:00 PM",start:"21:30",end:"22:00"}];async function q(e){try{let{PDFDocument:t,StandardFonts:n,rgb:s}=await a.e(3394).then(a.bind(a,63394)),i=await t.create(),l=i.addPage(),{width:r,height:o}=l.getSize(),c=await i.embedFont(n.Helvetica),d=await i.embedFont(n.HelveticaBold);l.drawText("Annadanam Pass",{x:40,y:o-40-18,size:18,font:d,color:s(0,0,0)});let u=o-40-36,m=(e,t)=>{l.drawText("".concat(e,": ").concat(null!=t?t:"-"),{x:40,y:u,size:11,font:c}),u-=16};m("Name",e.name),m("Email",e.email),e.phone&&m("Phone",e.phone),m("Date",e.date),m("Session",e.session),m("Qty",e.qty);let h="https://app.sabarisastha.org".replace(/\/$/,"")||"https://example.com",g="".concat(h,"/anna?b=").concat(encodeURIComponent(e.id),"&t=").concat(encodeURIComponent(e.qr_token||"")),p="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=".concat(encodeURIComponent(g)),f=await fetch(p),b=new Uint8Array(await f.arrayBuffer()),x=await i.embedPng(b),v=Math.min(r-80,220);l.drawImage(x,{x:40,y:Math.max(40,u-v-10),width:v,height:v});let w=await i.save(),y=new Blob([w],{type:"application/pdf"}),j=URL.createObjectURL(y),N=document.createElement("a");N.href=j,N.download="annadanam-pass-".concat(e.date,".pdf"),document.body.appendChild(N),N.click(),N.remove(),URL.revokeObjectURL(j)}catch(e){}}function A(e){let{slots:t,loading:a,onBook:i,date:o}=e,[c,d]=(0,s.useState)(""),[u,m]=(0,s.useState)("");if(a)return(0,n.jsx)("div",{className:"grid gap-4 md:grid-cols-2",children:[1,2].map(e=>(0,n.jsx)(r.Zp,{className:"animate-pulse",children:(0,n.jsx)(r.Wu,{className:"p-6",children:(0,n.jsx)("div",{className:"h-20 bg-muted rounded"})})},e))});let h=new Map(t.map(e=>[e.session,e])),g=B.map(e=>({label:e.label,slot:h.get(e.label)||null})),p=E.map(e=>({label:e.label,slot:h.get(e.label)||null})),f=t.filter(e=>B.some(t=>t.label===e.session)).reduce((e,t)=>e+t.booked_count,0),b=t.filter(e=>E.some(t=>t.label===e.session)).reduce((e,t)=>e+t.booked_count,0),x=e=>h.get(e)||null,v=e=>{let t=x(e);if(!t||(B.some(t=>t.label===e)?150-f:150-b)<=0)return!1;let a=0>=Math.max(0,t.capacity-t.booked_count)||"closed"===t.status,n=function(e,t){let a=function(e,t){let a=new Map;[...B,...E].forEach(e=>a.set(e.label,{start:e.start,end:e.end}));let n=a.get(t);if(!n)return null;let s=e.getFullYear(),i=e.getMonth(),l=e.getDate(),[r,o]=n.start.split(":").map(e=>parseInt(e,10)),[c,d]=n.end.split(":").map(e=>parseInt(e,10));return{start:new Date(s,i,l,r,o,0,0),end:new Date(s,i,l,c,d,0,0)}}(t,e);if(!a)return!1;let n=new Date,s=new Date(n.getTime()+60*n.getTimezoneOffset()*1e3+198e5),i=60*s.getHours()+s.getMinutes();try{let e=new URLSearchParams(window.location.search),t=null==e?void 0:e.get("devTime");if(t){let[e,a]=t.split(":").map(e=>parseInt(e,10));Number.isFinite(e)&&Number.isFinite(a)&&(i=e%24*60+a%60)}}catch(e){}let[l,r]=B.some(t=>t.label===e)?[660,690]:[900,1170];return!!(i>=l&&i<=r)&&!(n>=a.start)}(e,o);return!a&&n},w=(e,t,a,s)=>{let o=!(a&&v(a)),c="";if(a&&!v(a)){let e=B.some(e=>e.label===a);c=(e?150-f:150-b)<=0?"Session full":e?"Booking window: 11:00 AM–11:30 AM IST":"Booking window: 3:00 PM–7:30 PM IST"}return(0,n.jsx)(r.Zp,{children:(0,n.jsxs)(r.Wu,{className:"p-6",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,n.jsx)(N.A,{className:"h-5 w-5 text-primary"}),(0,n.jsx)("h3",{className:"font-semibold text-lg",children:e})]}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("select",{className:"w-full rounded-md border border-border bg-background p-2 text-sm",value:a,onChange:e=>s(e.target.value),children:[(0,n.jsx)("option",{value:"",children:"Select a time"}),t.map(e=>(0,n.jsxs)("option",{value:e.label,disabled:!v(e.label),children:[e.label,e.slot&&v(e.label)?"":" (unavailable)"]},e.label))]}),c?(0,n.jsx)("div",{className:"text-xs text-muted-foreground",children:c}):null,(0,n.jsx)(l.$,{className:"w-full",size:"sm",onClick:()=>(e=>{let t=x(e);t&&v(e)&&i(t.id)})(a),disabled:o,children:o?"Unavailable":"Book"})]})]})})};return(0,n.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[w("Afternoon",g,c,d),w("Evening",p,u,m)]})}function U(e){let{open:t,onClose:a,slot:i,onConfirm:r}=e,[o,c]=(0,s.useState)(1),[d,m]=(0,s.useState)(""),[h,w]=(0,s.useState)(""),[y,j]=(0,s.useState)("");return((0,s.useEffect)(()=>{t&&c(1)},[t]),i)?(i.capacity,i.booked_count,(0,n.jsx)(u,{open:t,onOpenChange:a,children:(0,n.jsxs)(g,{className:"sm:max-w-md",children:[(0,n.jsx)(p,{children:(0,n.jsxs)(b,{children:["Book ",i.session," Session"]})}),(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),r({qty:1,name:d.trim(),email:h.trim(),phone:y.trim()})},className:"space-y-4",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(v.J,{htmlFor:"name",children:"Name"}),(0,n.jsx)(x.p,{id:"name",value:d,onChange:e=>m(e.target.value),placeholder:"Your name",required:!0})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(v.J,{htmlFor:"email",children:"Email"}),(0,n.jsx)(x.p,{id:"email",type:"email",value:h,onChange:e=>w(e.target.value),placeholder:"you@example.com",required:!0})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(v.J,{htmlFor:"phone",children:"Phone Number"}),(0,n.jsx)(x.p,{id:"phone",type:"tel",value:y,onChange:e=>j(e.target.value),placeholder:"Your phone number"})]}),(0,n.jsxs)(f,{children:[(0,n.jsx)(l.$,{type:"button",variant:"outline",onClick:a,children:"Cancel"}),(0,n.jsx)(l.$,{type:"submit",children:"Confirm Booking"})]})]})]})})):null}function I(){let e=new Date,{start:t,end:o}=_(e),c=e<t||e>o?t:e,[d,u]=(0,s.useState)(c),[m,h]=(0,s.useState)([]),[g,p]=(0,s.useState)(!1),[f,b]=(0,s.useState)(!1),[x,v]=(0,s.useState)(null),[w,y]=(0,s.useState)([]),[N,B]=(0,s.useState)(!1),{ensure:I}=function(){let e=(0,s.useRef)(null);return{ensure:async function(){return e.current||(e.current=(await Promise.resolve().then(a.bind(a,96648))).getSupabaseBrowserClient()),e.current}}}(),{show:z}=(0,k.M)(),L=(0,s.useMemo)(()=>C(d),[d]),R=s.useCallback(e=>{let t=new Date,a=C(t),n=C(e);if(n<a)return!0;if(n>a)return!1;let[s,i]=(E[E.length-1].end||"22:00").split(":").map(e=>parseInt(e,10)),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),s||22,i||0,0,0);return new Date>=l},[]),T=(0,s.useMemo)(()=>{if(0===P.length)return t;let e=new Date(P.slice().sort()[0]);return e<t?e:t},[t]),F=(0,s.useMemo)(()=>{if(0===P.length)return o;let e=new Date(P.slice().sort().reverse()[0]);return e>o?e:o},[o]);async function Y(e){p(!0);try{let t=await I(),{data:a,error:n}=await t.rpc("get_annadanam_slots",{d:e});if(n)throw n;let s=Array.isArray(a)?a:[];h(s.map(e=>({id:"".concat(e.date,"-").concat(e.session),date:e.date,session:e.session,capacity:e.capacity,booked_count:e.booked_count,status:e.status})))}catch(e){console.error("get_annadanam_slots failed",e),h([])}finally{p(!1)}}async function O(){try{var e;let t=await I(),{data:a}=await t.auth.getUser(),n=null==a||null==(e=a.user)?void 0:e.id;if(!n)return y([]);let{data:s,error:i}=await t.from("Annadanam-Bookings").select("id,created_at,slot_id,user_id,name,email,phone,qty,status").eq("user_id",n).order("created_at",{ascending:!1});if(i)throw i;y(s||[])}catch(e){}}(0,s.useEffect)(()=>{try{let t=new URL(window.location.href).searchParams.get("date");if(!t)return;let a=t.split("-");if(3!==a.length)return;let n=parseInt(a[0],10),s=parseInt(a[1],10),i=parseInt(a[2],10);if(!n||!s||!i)return;let l=new Date(n,s-1,i);if(Number.isNaN(l.getTime()))return;D(l,e)&&u(l)}catch(e){}},[]),(0,s.useEffect)(()=>{Y(L)},[L]),(0,s.useEffect)(()=>{let e=()=>Y(L);return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)},[L]),(0,s.useEffect)(()=>{let e=null;return(async()=>{try{e=(await I()).channel("annadanam:".concat(L)).on("postgres_changes",{event:"*",schema:"public",table:"Bookings",filter:"date=eq.".concat(L)},()=>{Y(L)}).on("postgres_changes",{event:"*",schema:"public",table:"Slots",filter:"date=eq.".concat(L)},()=>{Y(L)}).subscribe()}catch(e){}})(),()=>{try{var t;null==e||null==(t=e.unsubscribe)||t.call(e)}catch(e){}}},[L]),(0,s.useEffect)(()=>{O()},[]);let Z=async e=>{if(x){if(x.capacity,x.booked_count,!e.email)return void z({title:"Email required",description:"Please enter your email.",variant:"warning"});try{let a=await I();try{let e="ssabarisasthass@gmail.com".split(/[\s,;]+/).filter(Boolean);if(!(e.length>0&&e.includes(String(s.email||"").toLowerCase()))&&!await (0,M.a)(a)){let e=window.location.pathname+window.location.search;z({title:"Identity document required",description:"Please upload Aadhaar or PAN in Profile → Edit. Redirecting in 5 seconds…",variant:"warning",durationMs:5e3}),setTimeout(()=>{try{window.location.assign("/profile/edit/?next="+encodeURIComponent(e))}catch(e){}},5e3);return}}catch(e){}let{data:n}=await a.auth.getUser(),s=null==n?void 0:n.user;if(!s){z({title:"Sign in required",description:"Please sign in to book.",variant:"warning"});try{let e="".concat(window.location.pathname).concat(window.location.search);window.location.assign("/sign-in/?next=".concat(encodeURIComponent(e)))}catch(e){}return}let i=new URLSearchParams(window.location.search).get("devTime")||"",l=!1,r=null;if(i){let n="ssabarisasthass@gmail.com".split(/[\s,;]+/).filter(Boolean),o=(s.email||"").toLowerCase();if(n.length>0&&n.includes(o)){var t;let{data:n}=await a.auth.getSession(),o=null==n||null==(t=n.session)?void 0:t.access_token;if(!o)throw Error("Not authenticated");let c=await fetch("/api/dev/annadanam/reserve",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({d:L,s:x.session,user_id:s.id,name:e.name,email:e.email,phone:e.phone,qty:1,dev_time:i})}),d=await c.json().catch(()=>({}));if(!c.ok)throw Error((null==d?void 0:d.error)||"Dev reserve failed");r=(null==d?void 0:d.row)||null,l=!0}}if(!l){let{data:t,error:n}=await a.rpc("reserve_annadanam_by_date",{d:L,s:x.session,user_id:s.id,name:e.name,email:e.email,phone:e.phone,qty:1});if(n)throw n;r=t||null}z({title:"Booking confirmed",description:"".concat(x.session," • ").concat(L),variant:"success"});try{let t=String((null==r?void 0:r.id)||""),a=String((null==r?void 0:r.qr_token)||"");await q({id:t,qr_token:a,date:L,session:x.session,name:e.name,email:e.email,phone:e.phone,qty:1})}catch(e){}try{await (0,S.Z)({to:e.email,subject:"Annadanam booking confirmed",text:"Your Annadanam booking for ".concat(L," (").concat(x.session,") has been received."),html:"<p>Your Annadanam booking for <strong>".concat(L,"</strong> (<strong>").concat(x.session,"</strong>) has been received.</p>")})}catch(e){}await Y(L),await O()}catch(a){let e=((null==a?void 0:a.message)||"Could not complete booking").toString(),t=/duplicate key|unique/i.test(e)?"You already booked this session.":/capacity|full|closed/i.test(e)?"Slot is full or closed.":"";z({title:"Booking failed",description:[e,t].filter(Boolean).join("\n"),variant:"error"})}finally{b(!1),v(null)}}};return(0,n.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-6xl",children:[(0,n.jsxs)("div",{className:"mb-8",children:[(0,n.jsx)("h2",{className:"text-2xl font-semibold",children:"Annadanam Slot Booking"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"Choose a time below. Booking windows (IST): Afternoon 11:00 AM–11:30 AM, Evening 3:00 PM – 7:30 PM."})]}),(0,n.jsxs)("div",{className:"grid gap-6 lg:grid-cols-3 mb-8",children:[(0,n.jsxs)("div",{className:"lg:col-span-1",children:[(0,n.jsx)("h3",{className:"text-base font-semibold mb-4",children:"Select Date"}),(0,n.jsx)(r.Zp,{className:"w-full",children:(0,n.jsx)(r.Wu,{className:"p-4",children:(0,n.jsx)(i.V,{selected:d,onSelect:t=>t&&D(t,e)&&u(t),disabled:t=>!D(t,e),completed:R,className:"rounded-lg border-0",fromDate:T,toDate:F})})})]}),(0,n.jsxs)("div",{className:"lg:col-span-2",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("h3",{className:"text-base font-semibold",children:["Select a Time — ",d.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]}),w.length>0&&(0,n.jsxs)(l.$,{variant:"outline",size:"sm",onClick:()=>B(e=>!e),children:[N?"Hide":"View"," My Bookings (",w.length,")"]})]}),N?(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h4",{className:"font-semibold",children:"My Bookings"}),w.map(e=>(0,n.jsx)(r.Zp,{children:(0,n.jsx)(r.Wu,{className:"p-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("p",{className:"font-medium",children:["Qty: ",e.qty]}),(0,n.jsxs)("p",{className:"text-sm text-muted-foreground",children:[e.name," • ",e.email]}),(0,n.jsx)("p",{className:"text-xs text-muted-foreground",children:new Date(e.created_at).toLocaleString()})]}),(0,n.jsx)(j,{children:e.status})]})})},e.id))]}):(0,n.jsx)(A,{slots:m,loading:g,onBook:e=>{let t=m.find(t=>t.id===e)||null;v(t),b(!!t)},date:d})]})]}),(0,n.jsx)(U,{open:f,onClose:()=>{b(!1),v(null)},slot:x,onConfirm:Z})]})}},80694:(e,t,a)=>{Promise.resolve().then(a.bind(a,30426)),Promise.resolve().then(a.bind(a,48210))}},e=>{e.O(0,[1029,5553,951,4909,2090,4361,8887,8441,1255,7358],()=>e(e.s=80694)),_N_E=e.O()}]);